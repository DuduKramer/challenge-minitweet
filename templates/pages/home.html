{% extends 'base.html' %}

{% block head_title %}This is amazing{% endblock head_title %}

{% block content %}
<div class="row text-center">
  <h1>Welcome to Mini-Tweet!</h1>
</div>

<div class="row mb-3">
  <div class="col-md-4 mx-auto col-10">
    <div id="tweet-error" class="d-none alert alert-danger"></div>
    <form id="tweet-form" class="form" method="POST" action="/create-tweet">
      <textarea required class="form-control" name="content" placeholder="Your tweet..."></textarea>
      <button type="submit" class="btn btn-primary mt-2">Tweet</button>
    </form>
  </div>
</div>

<div class="row" id="tweets-container">
  Loading...
</div>

<script>
const getJWTToken = () => {
  return localStorage.getItem('access_token') || ''; // Corrigido para usar 'access_token'
};

const showError = (msg) => {
  const errorDiv = document.getElementById('tweet-error');
  errorDiv.textContent = msg;
  errorDiv.classList.remove('d-none');
  setTimeout(() => errorDiv.classList.add('d-none'), 5000);
};

const clearError = () => {
  document.getElementById('tweet-error').classList.add('d-none');
};

const createTweetElement = ({ id, content, likes, username }) => {
  const tweetDiv = document.createElement('div');
  tweetDiv.className = 'tweet col-12 border rounded mb-3 p-3 bg-dark text-light';

  tweetDiv.innerHTML = `
    <p class="fs-6 mb-2"><strong>${username}</strong></p>
    <p class="fs-6 mb-2">${content}</p>
    <button class="btn btn-sm btn-primary like-btn" data-id="${id}" data-likes="${likes}" data-liked="false">
      Like (${likes})
    </button>
    <button class="btn btn-sm btn-danger delete-btn" data-id="${id}">
      Delete
    </button>
  `;

  tweetDiv.querySelector('.like-btn').addEventListener('click', handleLike);
  tweetDiv.querySelector('.delete-btn').addEventListener('click', handleDelete);
  return tweetDiv;
};

const handleDelete = async (event) => {
  const button = event.currentTarget;
  const tweetId = button.dataset.id;

  if (!confirm("Are you sure you want to delete this tweet?")) return;

  try {
    const jwtToken = getJWTToken();
    const res = await fetch(`/api/tweets/${tweetId}/delete`, {
      method: 'DELETE',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Authorization': `Bearer ${jwtToken}`,
      },
    });

    if (!res.ok) throw new Error('Failed to delete tweet');
    button.closest('.tweet').remove();
  } catch (err) {
    console.error('Delete error:', err);
    alert('Error deleting tweet. Please try again.');
  }
};

const renderTweets = (tweets) => {
  const container = document.getElementById('tweets-container');
  container.innerHTML = '';

  if (!tweets.length) {
    container.innerHTML = '<p>No tweets available.</p>';
    return;
  }

  tweets.forEach(tweet => {
    const tweetEl = createTweetElement(tweet);
    container.appendChild(tweetEl);
  });
};

const fetchTweets = async () => {
  const token = getJWTToken(); // Usando função getJWTToken
  try {
    const res = await fetch('/tweets', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!res.ok) {
      if (res.status === 401) {
        alert('Unauthorized! Please log in again.');
        window.location.href = '/login/';
      }
      throw new Error('Failed to load tweets');
    }

    const data = await res.json();
    renderTweets(data);
  } catch (err) {
    console.error(err.message);
    document.getElementById('tweets-container').innerHTML = '<p>Error loading tweets.</p>';
  }
};

const handleTweetSubmit = async (e) => {
  e.preventDefault();
  clearError();

  const form = e.target;
  const formData = new FormData(form);
  const token = localStorage.getItem('access_token'); // Obtém o token de acesso do localStorage

  try {
    const res = await fetch(form.action, {
      method: form.method,
      headers: {
        'Authorization': `Bearer ${token}`, // Inclui o token no cabeçalho
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: formData,
    });

    if (res.status === 401) {
      window.location.href = '/login';
      return;
    }

    if (!res.ok) {
      const errorData = await res.json();
      const messages = Object.values(errorData).flat().join(' ');
      showError(messages);
      return;
    }

    await res.json();
    form.reset();
    fetchTweets();
  } catch (err) {
    console.error('Tweet submit error:', err);
    showError('Error submitting tweet.');
  }
};

async function handleLike(event) {
  const button = event.currentTarget;
  const tweetId = button.dataset.id;
  let localCount = parseInt(button.dataset.likes, 10);
  const action = button.dataset.liked === 'true' ? 'unlike' : 'like';
  const url = `/api/tweet/${tweetId}/like-toggle/`;

  if (action === 'like') {
    localCount += 1;
    button.dataset.liked = 'true';
  } else {
    localCount -= 1;
    button.dataset.liked = 'false';
  }

  button.dataset.likes = localCount;
  button.textContent = `Like (${localCount})`;

  const jwtToken = getJWTToken();

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'Authorization': `Bearer ${jwtToken}`,
      },
      body: JSON.stringify({ action: action }),
    });

    if (!response.ok) throw new Error(`Server error: ${response.status}`);

    const responseData = await response.json();
    button.dataset.likes = responseData.likes_count;
    button.textContent = `Like (${responseData.likes_count})`;
    button.dataset.liked = responseData.liked.toString();

  } catch (error) {
    console.error('Failed to update like:', error);

    let revertedCount = action === 'like' ? localCount - 1 : localCount + 1;
    button.dataset.likes = revertedCount;
    button.textContent = `Like (${revertedCount})`;

    alert('Could not register your like. Please try again.');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  fetchTweets();

  const form = document.getElementById('tweet-form');
  form.addEventListener('submit', handleTweetSubmit);
  form.querySelector('textarea').addEventListener('input', clearError);
});
</script>

{% endblock content %}
