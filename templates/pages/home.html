{% extends 'base.html' %}

{% block head_title %}This is amazing{% endblock head_title %}

{% block content %}
<div class="row text-center">
  <h1>Welcome to Mini-Tweet!</h1>
</div>

<div class="row mb-3">
  <div class="col-md-4 mx-auto col-10">
    <div id="tweet-error" class="d-none alert alert-danger"></div>
    <form id="tweet-form" class="form" method="POST" action="/create-tweet">
      {% csrf_token %}
      <input type="hidden" name="next" value="/" />
      <textarea required class="form-control" name="content" placeholder="Your tweet..."></textarea>
      <button type="submit" class="btn btn-primary mt-2">Tweet</button>
    </form>
  </div>
</div>

<div class="row" id="tweets-container">
  Loading...
</div>

<script>
  const getCSRFToken = () => {
    return document.cookie
      .split('; ')
      .find(row => row.startsWith('csrftoken='))
      ?.split('=')[1] || '';
  };

  const showError = (msg) => {
    const errorDiv = document.getElementById('tweet-error');
    errorDiv.textContent = msg;
    errorDiv.classList.remove('d-none');
    setTimeout(() => errorDiv.classList.add('d-none'), 5000);
  };

  const clearError = () => {
    document.getElementById('tweet-error').classList.add('d-none');
  };

  const createTweetElement = ({ id, content, likes }) => {
    const tweetDiv = document.createElement('div');
    tweetDiv.className = 'tweet col-12 border rounded mb-3 p-3 bg-dark text-light';

    tweetDiv.innerHTML = `
    <p class="fs-6 mb-2">${content}</p>
    <button class="btn btn-sm btn-primary like-btn" data-id="${id}" data-likes="${likes}" data-liked="false">
      Like (${likes})
    </button>
  `;

    tweetDiv.querySelector('.like-btn').addEventListener('click', handleLike);
    return tweetDiv;
  };

  const renderTweets = (tweets) => {
    const container = document.getElementById('tweets-container');
    container.innerHTML = '';

    if (!tweets.length) {
      container.innerHTML = '<p>No tweets available.</p>';
      return;
    }

    tweets.forEach(tweet => {
      const tweetEl = createTweetElement(tweet);
      container.appendChild(tweetEl);
    });
  };

  const fetchTweets = async () => {
    try {
      const res = await fetch('/tweets');
      if (!res.ok) throw new Error('Failed to load tweets');
      const data = await res.json();
      renderTweets(data);
    } catch (err) {
      console.error(err);
      document.getElementById('tweets-container').innerHTML = '<p>Error loading tweets.</p>';
    }
  };

  const handleTweetSubmit = async (e) => {
    e.preventDefault();
    clearError();

    const form = e.target;
    const formData = new FormData(form);

    try {
      const res = await fetch(form.action, {
        method: form.method,
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData,
      });

      if (res.status === 401) {
        window.location.href = '/login';
        return;
      }

      if (!res.ok) {
        const errorData = await res.json();
        const messages = Object.values(errorData).flat().join(' ');
        showError(messages);
        return;
      }

      await res.json();
      form.reset();
      fetchTweets();
    } catch (err) {
      console.error('Tweet submit error:', err);
      showError('Error submitting tweet.');
    }
  };

  async function handleLike(event) {
  const button = event.currentTarget;
  const tweetId = button.dataset.id;
  let localCount = parseInt(button.dataset.likes, 10);
  const action = button.dataset.liked === 'true' ? 'unlike' : 'like';
  const url = `/api/tweet/${tweetId}/like-toggle/`;  // Updated to match your URL pattern

  // Atualiza localmente para dar feedback rápido
  if (action === 'like') {
      localCount += 1;
      button.dataset.liked = 'true';
  } else {
      localCount -= 1;
      button.dataset.liked = 'false';
  }
  
  button.dataset.likes = localCount;
  button.textContent = `Like (${localCount})`;

  const csrfToken = getCSRFToken();  // Use the existing getCSRFToken function

  try {
      const response = await fetch(url, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ action: action })
      });

      if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
      }

      const responseData = await response.json();

      // Atualiza o botão com a nova contagem de likes
      button.dataset.likes = responseData.likes_count;
      button.textContent = `Like (${responseData.likes_count})`;
      button.dataset.liked = responseData.liked.toString();

  } catch (error) {
      console.error('Failed to update like:', error);

      // Opcional: reverter o contador local se der erro
      let revertedCount = action === 'like' ? localCount - 1 : localCount + 1;
      button.dataset.likes = revertedCount;
      button.textContent = `Like (${revertedCount})`;

      alert('Could not register your like. Please try again.');
  }
}

  document.addEventListener('DOMContentLoaded', () => {
    fetchTweets();

    const form = document.getElementById('tweet-form');
    form.addEventListener('submit', handleTweetSubmit);

    form.querySelector('textarea').addEventListener('input', clearError);
  });
</script>

{% endblock content %}
